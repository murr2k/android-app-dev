name: Deploy to Play Store

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.2.3
  workflow_dispatch:  # Allow manual trigger
    inputs:
      track:
        description: 'Release track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
      submit_for_review:
        description: 'Submit for review (clicks the Submit button)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write  # Allow pushing commits

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Auto-increment version
        id: version
        run: |
          # Read current version
          VERSION_CODE=$(grep versionCode version.properties | cut -d'=' -f2)
          VERSION_NAME=$(grep versionName version.properties | cut -d'=' -f2)
          
          # Increment version code
          NEW_VERSION_CODE=$((VERSION_CODE + 1))
          
          # Extract version name from tag if available
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            NEW_VERSION_NAME="${{ github.ref_name }}"
            NEW_VERSION_NAME="${NEW_VERSION_NAME#v}"  # Remove 'v' prefix
          else
            # Auto-increment patch version
            IFS='.' read -ra VERSION_PARTS <<< "$VERSION_NAME"
            PATCH=$((VERSION_PARTS[2] + 1))
            NEW_VERSION_NAME="${VERSION_PARTS[0]}.${VERSION_PARTS[1]}.$PATCH"
          fi
          
          # Update version.properties
          echo "versionCode=$NEW_VERSION_CODE" > version.properties
          echo "versionName=$NEW_VERSION_NAME" >> version.properties
          
          # Output for use in next steps
          echo "version_code=$NEW_VERSION_CODE" >> $GITHUB_OUTPUT
          echo "version_name=$NEW_VERSION_NAME" >> $GITHUB_OUTPUT
          
          # Create changelog if it doesn't exist
          mkdir -p fastlane/metadata/android/en-US/changelogs
          if [ ! -f "fastlane/metadata/android/en-US/changelogs/$NEW_VERSION_CODE.txt" ]; then
            echo "Version $NEW_VERSION_NAME ($NEW_VERSION_CODE)" > "fastlane/metadata/android/en-US/changelogs/$NEW_VERSION_CODE.txt"
            echo "" >> "fastlane/metadata/android/en-US/changelogs/$NEW_VERSION_CODE.txt"
            echo "â€¢ Automated release via GitHub Actions" >> "fastlane/metadata/android/en-US/changelogs/$NEW_VERSION_CODE.txt"
            echo "â€¢ Bug fixes and performance improvements" >> "fastlane/metadata/android/en-US/changelogs/$NEW_VERSION_CODE.txt"
          fi
          
      - name: Make gradlew executable
        run: chmod +x android/gradlew
        
      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/linknode-release.keystore
          
      - name: Build AAB
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cd android
          ./gradlew bundleRelease
          
      - name: Determine track and status
        id: deployment
        run: |
          # Default track based on trigger
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Tag push defaults to alpha
            TRACK="alpha"
            STATUS="completed"
          else
            # Manual trigger uses input
            TRACK="${{ github.event.inputs.track || 'internal' }}"
            
            # Determine release status
            if [[ "${{ github.event.inputs.submit_for_review }}" == "true" ]]; then
              STATUS="completed"  # Submits for review
              echo "âœ… Release will be submitted for review"
            else
              STATUS="draft"  # Saves as draft, manual review needed
              echo "ðŸ“ Release will be saved as draft"
            fi
          fi
          
          echo "track=$TRACK" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "ðŸ“± Deploying to track: $TRACK with status: $STATUS"
          
      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: com.linknode.showcase
          releaseFiles: android/app/build/outputs/bundle/release/*.aab
          track: ${{ steps.deployment.outputs.track }}
          status: ${{ steps.deployment.outputs.status }}
          whatsNewDirectory: fastlane/metadata/android/en-US/changelogs/
          inAppUpdatePriority: 2
          
      - name: Commit version changes
        if: success()
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          git add version.properties
          git add "fastlane/metadata/android/en-US/changelogs/${{ steps.version.outputs.version_code }}.txt"
          
          git commit -m "ðŸ¤– Auto-increment version to ${{ steps.version.outputs.version_name }} (${{ steps.version.outputs.version_code }})" || echo "No changes to commit"
          git push